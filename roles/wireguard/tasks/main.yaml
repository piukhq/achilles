---
- name: install wireguard
  apt:
    name: wireguard
    update_cache: true
    state: present
  
- name: enable wireguard
  systemd:
    name: wg-quick@wg0
    enabled: true
    daemon_reload: true

- name: add ipforward in wiregard conf
  copy:
    dest: /etc/sysctl.d/99-wireguard.conf
    owner: root
    group: root
    content: |
      net.ipv4.ip_forward = 1
  register: ipforward

- name: reload sysctl
  command: sysctl --system
  when: ipforward.changed == True

- name: populate wireguard conf file
  template:
    src: wireguard.conf.j2
    dest: /etc/wireguard/wg0.conf
    owner: root
    group: root
    mode: '0640'
  vars:
    server_private_key: '{{ wireguard_server_private_key }}'
    users: '{{ wireguard_users }}'
  notify: 
  - restart wireguard
  - restart automount

- name: update cifs-utils
  apt:
    name: cifs-utils
    update_cache: true

- name: create mount dir
  file:
    name: '{{ item }}'
    state: directory
  with_items:
    - /mnt/binkuksouthwireguard
    - /mnt/binkuksouthwireguard/users

- name: install mount service scripts
  copy:
    src: '{{ item }}'
    dest: /etc/systemd/system/{{ item }}
    mode: '0644'
  with_items:
    - mnt-binkuksouthwireguard-users.mount
    - mnt-binkuksouthwireguard-users.automount

- name: enable automount service
  systemd:
    name: mnt-binkuksouthwireguard-users.automount
    daemon_reload: true
    enabled: true
    state: started

- name: create files for each user
  template:
    src: users.conf.j2
    dest: /mnt/binkuksouthwireguard/users/{{ item.name }}.conf
    owner: root
    group: root
    mode: '0644'
  vars:
    private: '{{ item.private }}'
    address: '{{ item.ip }}'
    srv_public: '{{ wireguard_server_public_key }}'
    srv_endpoint: '{{ wireguard_server_fqdn }}'
    srv_port: '{{ wireguard_server_port }}'
  loop: '{{ wireguard_users }}'
